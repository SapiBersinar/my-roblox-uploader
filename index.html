<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox Asset Uploader</title>
    <!-- Tailwind CSS CDN untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-2xl bg-gray-800 rounded-2xl shadow-xl p-8 space-y-8">
        <h1 class="text-3xl font-bold text-center text-blue-400">Roblox Asset Uploader</h1>
        
        <!-- Bagian Input API Key dan User ID -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-200">Kredensial</h2>
            <p class="text-sm text-gray-400">
                Data akan dikirim ke backend Anda, bukan langsung ke Roblox API.
            </p>
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <div class="flex-1 w-full">
                    <label for="apiKey" class="block text-sm font-medium text-gray-300">Roblox Open Cloud API Key</label>
                    <input type="password" id="apiKey" placeholder="Masukkan API Key"
                           class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-gray-100">
                </div>
                <div class="flex-1 w-full">
                    <label for="userId" class="block text-sm font-medium text-gray-300">Roblox User ID</label>
                    <input type="text" id="userId" placeholder="Masukkan User ID"
                           class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-gray-100">
                </div>
            </div>
            <div class="flex justify-end gap-2">
                <button id="saveCredentials"
                        class="px-4 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition duration-300">
                    Simpan
                </button>
                <button id="deleteCredentials"
                        class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                    Hapus
                </button>
            </div>
        </section>

        <hr class="border-gray-700">

        <!-- Bagian Unggah File -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-200">Unggah Aset</h2>
            <div>
                <label for="fileInput" class="block text-sm font-medium text-gray-300">Pilih file PNG/JPG</label>
                <input type="file" id="fileInput" multiple accept="image/png,image/jpeg"
                       class="mt-1 block w-full text-sm text-gray-400
                              file:mr-4 file:py-2 file:px-4
                              file:rounded-lg file:border-0
                              file:text-sm file:font-semibold
                              file:bg-blue-500 file:text-white
                              hover:file:bg-blue-600 cursor-pointer">
            </div>
            <div class="flex gap-4">
                <div class="flex-1">
                    <label for="displayName" class="block text-sm font-medium text-gray-300">Nama Tampilan</label>
                    <input type="text" id="displayName" placeholder="Nama (kosong = random)"
                           class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-gray-100">
                </div>
                <div class="flex-1">
                    <label for="description" class="block text-sm font-medium text-gray-300">Deskripsi</label>
                    <input type="text" id="description" placeholder="Deskripsi (kosong = random)"
                           class="mt-1 block w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-gray-100">
                </div>
            </div>
            <button id="uploadButton"
                    class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105">
                Mulai Unggah
            </button>
        </section>

        <hr class="border-gray-700">

        <!-- Bagian Log dan Status -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-200">Log Unggahan</h2>
            <div id="logContainer" class="bg-gray-900 rounded-lg p-4 h-64 overflow-y-auto border border-gray-700 text-sm">
                <p class="text-gray-500">Log akan ditampilkan di sini...</p>
            </div>
        </section>
        
        <!-- Modal untuk Alert -->
        <div id="alertModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4">
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full text-center space-y-4">
                <p id="alertMessage" class="text-lg font-medium text-white"></p>
                <button id="alertClose" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Tutup</button>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Element HTML
            const apiKeyInput = document.getElementById('apiKey');
            const userIdInput = document.getElementById('userId');
            const saveCredentialsBtn = document.getElementById('saveCredentials');
            const deleteCredentialsBtn = document.getElementById('deleteCredentials');
            const uploadButton = document.getElementById('uploadButton');
            const fileInput = document.getElementById('fileInput');
            const displayNameInput = document.getElementById('displayName');
            const descriptionInput = document.getElementById('description');
            const logContainer = document.getElementById('logContainer');
            const alertModal = document.getElementById('alertModal');
            const alertMessage = document.getElementById('alertMessage');
            const alertCloseBtn = document.getElementById('alertClose');
            
            // Konfigurasi backend (URL Netlify Function)
            const BACKEND_URL = '/.netlify/functions/upload';

            // Fungsi utilitas
            const showMessage = (msg) => {
                alertMessage.textContent = msg;
                alertModal.classList.remove('hidden');
            };
            alertCloseBtn.addEventListener('click', () => {
                alertModal.classList.add('hidden');
            });
            const random5Char = () => Math.random().toString(36).substring(2, 7);
            const log = (message, color = 'text-gray-300') => {
                const p = document.createElement('p');
                p.textContent = message;
                p.className = `font-mono ${color}`;
                logContainer.appendChild(p);
                logContainer.scrollTop = logContainer.scrollHeight;
            };

            // ====== Kelola Kredensial di Local Storage ======
            const loadCredentials = () => {
                const storedApiKey = localStorage.getItem('robloxApiKey');
                const storedUserId = localStorage.getItem('robloxUserId');
                if (storedApiKey) {
                    apiKeyInput.value = storedApiKey;
                    apiKeyInput.type = 'password';
                }
                if (storedUserId) {
                    userIdInput.value = storedUserId;
                }
            };
            
            saveCredentialsBtn.addEventListener('click', () => {
                const key = apiKeyInput.value.trim();
                const id = userIdInput.value.trim();
                if (key && id) {
                    localStorage.setItem('robloxApiKey', key);
                    localStorage.setItem('robloxUserId', id);
                    showMessage('Kredensial berhasil disimpan!');
                    loadCredentials();
                } else {
                    showMessage('API Key dan User ID tidak boleh kosong.');
                }
            });

            deleteCredentialsBtn.addEventListener('click', () => {
                localStorage.removeItem('robloxApiKey');
                localStorage.removeItem('robloxUserId');
                apiKeyInput.value = '';
                userIdInput.value = '';
                apiKeyInput.type = 'password';
                showMessage('Kredensial berhasil dihapus.');
            });

            // ====== Logika Unggahan ======
            uploadButton.addEventListener('click', async () => {
                const apiKey = localStorage.getItem('robloxApiKey');
                const userId = localStorage.getItem('robloxUserId');
                const files = fileInput.files;
                const displayName = displayNameInput.value.trim();
                const description = descriptionInput.value.trim();

                if (!apiKey || !userId) {
                    return showMessage('Harap simpan API Key dan User ID terlebih dahulu.');
                }
                if (files.length === 0) {
                    return showMessage('Pilih setidaknya satu file untuk diunggah.');
                }

                uploadButton.disabled = true;
                logContainer.innerHTML = '';
                log('Memulai proses unggah melalui Netlify Function...', 'text-blue-400');
                
                try {
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const finalDisplayName = displayName || random5Char();
                        const finalDescription = description || random5Char();

                        log(`[${i + 1}/${files.length}] Mengunggah "${file.name}"...`, 'text-yellow-400');
                        
                        const formData = new FormData();
                        formData.append('apiKey', apiKey);
                        formData.append('userId', userId);
                        formData.append('displayName', finalDisplayName);
                        formData.append('description', finalDescription);
                        formData.append('fileContent', file);

                        const res = await fetch(BACKEND_URL, {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await res.json();

                        if (res.ok) {
                            if (data.status === 'success') {
                                log(`✅ Unggahan ${file.name} berhasil!`, 'text-green-400');
                                log(`   Asset ID: ${data.assetId}`);
                                log(`   Nama: ${data.name}`);
                            } else {
                                log(`❌ Unggahan ${file.name} gagal.`, 'text-red-400');
                                log(`   Pesan: ${data.message || 'Kesalahan tidak diketahui'}`, 'text-red-400');
                            }
                        } else {
                            log(`❌ Unggahan ${file.name} gagal.`, 'text-red-400');
                            log(`   Status: ${res.status}`, 'text-red-400');
                            log(`   Pesan: ${data.message || 'Kesalahan backend tidak diketahui'}`, 'text-red-400');
                        }

                        // Jeda singkat antar unggahan
                        if (i < files.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 2500));
                        }
                    }

                    log('\nSemua unggahan selesai!', 'text-blue-400');

                } catch (error) {
                    log(`Terjadi kesalahan: ${error.message}`, 'text-red-400');
                    showMessage(`Terjadi kesalahan: ${error.message}`);
                } finally {
                    uploadButton.disabled = false;
                }
            });

            loadCredentials();
        });
    </script>
</body>
</html>

